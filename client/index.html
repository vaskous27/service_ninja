<html ng-app="serviceninja">
<head>
  <title>Service Ninjas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">
  <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular-route.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/angular-moment/0.9.0/angular-moment.min.js"></script>
  <link href="/stylesdashboard.css" rel="stylesheet">
  <script>
      $(document).ready(function() {
          $('select').material_select();
          // the "href" attribute of .modal-trigger must specify the modal ID that wants to be triggered
          
          });
     
     


  	  var serviceninja = angular.module('serviceninja', ['ngRoute', 'angularMoment']);

      serviceninja.config(function ($routeProvider) {
          $routeProvider
            .when('/',{
                  templateUrl: 'partials/front.html',
                  controller: 'ApplicationController'
                })
            .when('/howitworks',{
                  templateUrl: 'partials/how-it-works.html'
                })
            .when('/about',{
                  templateUrl: 'partials/about.html'
                })
            // .when('/login', {
            //     templateUrl: 'partials/logIn.html'
            // }) 
            .when('/register', {
                templateUrl: 'partials/register.html'
            }) 
            .when('/dashboard', {
                templateUrl: 'partials/dashboard.html'
            })            
             .when('/profile', {
                templateUrl: 'partials/profileView.html'
            })
             .when('/form', {
                templateUrl: 'partials/profileForm.html'
            })
            .when('/message', {
                templateUrl: 'partials/message.html'

            })                        
            .otherwise({
              redirectTo: '/'
            });
      })
//factories
    serviceninja.factory('serviceFactory', function($http){
      var factory = {};
      var currentService = {};
      var services = [];
      factory.index = function(callback){
        $http.get('/services').success(function(output){
          services = output;
          callback(output);
        })
      }
      factory.create = function(newService, callback){
        $http.post('/services', newService).success(function(output){
          currnetService = output;
          callback(output);
        })
      }
      factory.find = function(id, callback){
        $http.get('/services/' + id).success(function(output){
          callback(output);
        })
      }
      return factory;
    })
    serviceninja.factory('categoryFactory', function($http){
      var factory = {};
      var categories = [];
      factory.index = function(callback){
        $http.get('/categories').success(function(output){
          categories = output;
          callback(output);
        })
      }
      return factory;
    })

    serviceninja.factory('AuthService', function ($http, Session) {
      var authService = {};
      authService.login = function (credentials) {
        return $http
          .post('/login', credentials)
          .then(function (res) {
            Session.create(res.data.id, res.data.user.id,
                           res.data.user.role);
            return res.data.user;
          });
      };
     
      authService.isAuthenticated = function () {
        return !!Session.userId;
      };
     
      authService.isAuthorized = function (authorizedRoles) {
        if (!angular.isArray(authorizedRoles)) {
          authorizedRoles = [authorizedRoles];
        }
        return (authService.isAuthenticated() &&
          authorizedRoles.indexOf(Session.userRole) !== -1);
      };
     
      return authService;
    })

    serviceninja.constant('AUTH_EVENTS', {
      loginSuccess: 'auth-login-success',
      loginFailed: 'auth-login-failed',
      logoutSuccess: 'auth-logout-success',
      sessionTimeout: 'auth-session-timeout',
      notAuthenticated: 'auth-not-authenticated',
      notAuthorized: 'auth-not-authorized'
    })

    .constant('USER_ROLES', {
      all: '*',
      admin: 'admin',
      editor: 'editor',
      guest: 'guest'
    })

    serviceninja.service('Session', function () {
      this.create = function (sessionId, userId, userRole) {
        this.id = sessionId;
        this.userId = userId;
        this.userRole = userRole;
      };
      this.destroy = function () {
        this.id = null;
        this.userId = null;
        this.userRole = null;
      };
    })

    serviceninja.controller('LoginController', function ($scope, $rootScope, AUTH_EVENTS, AuthService) {
      $scope.credentials = {
        username: '',
        password: ''
      };
      $scope.login = function (credentials) {
        console.log($scope.credentials)
        AuthService.login(credentials).then(function (user) {
          $rootScope.$broadcast(AUTH_EVENTS.loginSuccess);
          $scope.setCurrentUser(user);
        }, function () {
          $rootScope.$broadcast(AUTH_EVENTS.loginFailed);
        });
      };
    })

    serviceninja.controller('ApplicationController', function ($scope, USER_ROLES,AuthService) {
      $scope.currentUser = null;
      $scope.userRoles = USER_ROLES;
      $scope.isAuthorized = AuthService.isAuthorized;
     
      $scope.setCurrentUser = function (user) {
        $scope.currentUser = user;
      };
    })
      
  </script>
</head>
<body>
  <div ng-view="">
  </div>
</body>
</html>
